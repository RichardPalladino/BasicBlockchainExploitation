import pytest

from brownie import accounts, exceptions

from scripts.deploy import deploy_bec_safe


def test_deposit():
    # Arrange
    bec_safe = deploy_bec_safe()
    # Act
    bec_safe.deposit({"from": accounts[1], "value": 100})
    # Assert
    assert bec_safe.getBalance({"from": accounts[1]}) == 100


def test_transfer_success():
    # Arrange
    bec_safe = deploy_bec_safe()
    # Act 1
    bec_safe.deposit({"from": accounts[0], "value": 100})
    # Assert 1
    assert bec_safe.getBalance({"from": accounts[0]}) == 100
    # Act 2
    bec_safe.batchTransfer([accounts[1], accounts[2]], 50, {"from": accounts[0]})
    # Assert 2
    assert bec_safe.getBalance({"from": accounts[1]}) == 50
    assert bec_safe.getBalance({"from": accounts[2]}) == 50


def test_transfer_fail():
    # Arrange
    bec_safe = deploy_bec_safe()
    # Act
    bec_safe.deposit({"from": accounts[0], "value": 100})
    # Assert
    assert bec_safe.getBalance({"from": accounts[0]}) == 100
    with pytest.raises(exceptions.VirtualMachineError):
        bec_safe.batchTransfer([accounts[1], accounts[2]], 60, {"from": accounts[0]})
    assert bec_safe.getBalance({"from": accounts[0]}) == 100


def test_attack_fail():
    # Arrange
    bec_safe = deploy_bec_safe()
    # Act 1
    bec_safe.deposit({"from": accounts[0], "value": 10})
    # Assert 1
    assert bec_safe.getBalance({"from": accounts[0]}) == 10
    with pytest.raises(exceptions.VirtualMachineError):
        bec_safe.batchTransfer(
            [accounts[1], accounts[2]],
            0x8000000000000000000000000000000000000000000000000000000000000000,
            {"from": accounts[0]},
        )
    assert bec_safe.getBalance({"from": accounts[0]}) == 10
    assert bec_safe.getBalance({"from": accounts[1]}) == 0
    assert bec_safe.getBalance({"from": accounts[2]}) == 0
